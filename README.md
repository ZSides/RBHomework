# Wordpress Ansible playbook
Данный Ansible playbook предназначен для установки wordpress на машины под управлением ОС centos7. Работа на других машинах не тестировалась, но возможна.

## Vagrant
Vagrantfile сконфигурирован таким образом, чтобы поднять виртуальные машины virtualbox под управлением centos7. Количество виртуальных машин изменяется заданием переменной *N*.

Ансибловый провижионер запустит playbook.yml сразу после поднятия виртуальных маших командой vagrant up.
### Если требуется запуск на другой конфигурации:
- Создайте *invenory* файл, например, hosts.
- Задайте путь до него в файле конфигурации *ansible.cfg* 
    > inventory = hosts
- Опишите свою рабочую структуру в файле hosts
    > Подробнее о том как это сделать в [официальной документации](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)
- Запустите playbook командой ansible-playbook playbook.yml

## Структура плейбука
Все команды выполняются от суперпользователя.

В секции vars_files описаны переменные, не рекомендуется изменять файлы php_settings.yml и adminer_settings.yml, если вы не уверены в том, что вы делаете.

В файле mysql_settings.yml задаётся имя и пароль пользователя для базы данных. Рекомендуется шифровать пароль с помощью ansible-vault. Путь до файла-пароля находится в ansible.cfg. При этом созданный пользователь будет иметь доступ только к одной базе данных.

Вы можете переопределить стандартные переменные любым удобным способом, например указав в vars.
- wordpress_path - определяет папку, в которую будет разархивирован wordpress. Путь указывается относительно корневой директории веб-сервера.
- wordpress_database_name - определяет имя для базы данных wordpress
- wordpress_prefix - определяет префикс таблиц, измените, если планируется, что несколько установок wordpress будут пользоваться одной БД.

[Список всех стандартных переменных роли wordpress.](roles/wordpress/defaults/main.yml)

Затем идёт описание ролей. Я использую 6 ролей из из Ansible Galaxy:
- geerlingguy.repo-epel Добавление репозитория epel для установки php и mysql версии, приемлемой для современного wordpress.
- geerlingguy.repo-remi Добавление репозитория remi для установки php и mysql версии, приемлемой для современного wordpress.
- geerlingguy.apache    Установка веб-сервера apache.
- geerlingguy.php       Установка php и модуля php-mysql для работы с БД.
- geerlingguy.mysql     Установка MariaDB
- geerlingguy.adminer   Установка инструмента для администрирования БД. Опционально.
Далее я использую свою роль для настройки БД под wordpress, установки wordpress и конфигурации wp-config.php по шаблону.

## Самописная роль wordpress
Мной была написана роль, устанавливающая wordpress.
### Структура:
- wordpress
    - defaults
        - main.yml
    - tasks
        - main.yml
        - configure.yml
        - database.yml
        - download.yml
    - templates
        - wp-config.php.j2

Таска main.yml вызывает остальные три.

Сначала database.yml с помощью модуля mysql_db создаст БД, затем mysql_user создаст пользователя с правами только на эту БД.

Затем будут обработаны таски в файле download.yml. Они загрузят на управляющую машину архив с последней версией wordpress. Архив будет разархивирован во временную директорию на каждой управляемой машине. Затем перемещен из директории wordpress во временной директории в директорию на сервере. Временная директория удаляется.

Последним шагом по шаблону настраивается wp-config.php, в нем wordpress подключается к БД.